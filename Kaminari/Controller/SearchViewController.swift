//
//  Created by (^„Öó^)7 iMac on 2023/09/25.
//

import SnapKit
import UIKit
import MapKit
import Foundation
import WeatherKit

let defaults = UserDefaults.standard // UserdefaultsÎ°ú ÏÑ≠Ïî®, ÌôîÏî® ÏÑ§Ï†ï
let defaultUnit = ["tempUnit": "ÏÑ≠Ïî®"] // Í∏∞Î≥∏Í∞í



var locationData: [LocationData] = []

struct LocationData {
    var name: String?
    var latitude: Double?
    var longtitude: Double?
}

struct WeatherData {
    var condition: WeatherCondition?
    var symbolName: String?
    var date: Date?
    var temperature: Int?
    var isDaylight: Bool?
}

struct CurrentWeatherData {
    var locationData: LocationData
    var weatherData: WeatherData
}

class SearchViewController: UITableViewController {
    var weather: Weather?
    var tempWeatherData: WeatherData = WeatherData()
    var locationManager = MapManager.locationManager
    var currentWeatherData: [CurrentWeatherData]? = []
    
    override func viewDidLoad() {
        super.viewDidLoad()
        let currentLocant = configureMapData()
        print("ÌòÑÏû¨ ÏúÑÏπò Îç∞Ïù¥ÌÑ∞: \(currentLocant)")

        defaults.register(defaults: defaultUnit)
        
        view.backgroundColor = .systemBackground

        // register cell
        tableView.register(SearchTableViewCell.self, forCellReuseIdentifier: SearchTableViewCell.identifier)

        // ÌÖåÏù¥Î∏îÎ∑∞ delegate
        tableView.delegate = self
        tableView.dataSource = self

        // cell Íµ¨Î∂ÑÏÑ† ÏóÜÏï†Í∏∞
        tableView.separatorStyle = .none

       // ÌÉ≠ Î∞î ÏóÜÏï†Í∏∞
        tabBarController?.tabBar.isHidden = true
        
        // dark mode
        view.window?.overrideUserInterfaceStyle = .dark
    }

    override func viewWillAppear(_ animated: Bool) {
        navBar()
        let currentLocant = configureMapData()
        
        if locationData.count == 0 {locationData.append(currentLocant)}
        else {locationData[0] = currentLocant}
             print("viewWillAppear locationData: \(String(describing: locationData))")
        
        fetchData(locationArray: locationData)
        view.window?.overrideUserInterfaceStyle = .dark
    }

    override func viewWillDisappear(_ animated: Bool) {
        tabBarController?.tabBar.isHidden = false
        self.navigationController?.navigationBar.backgroundColor = .clear
        self.navigationController?.navigationBar.prefersLargeTitles = false
        view.window?.overrideUserInterfaceStyle = .unspecified
    }

   func navBar() {
       let menuButton = UIButton(frame: CGRect(x: 0, y: 0, width: 30, height: 30))
       menuButton.showsMenuAsPrimaryAction = true
       menuButton.menu = setMenu()
       menuButton.setImage(UIImage(systemName: "ellipsis.circle"), for: .normal)

       let barButton = UIBarButtonItem(customView: menuButton)
       barButton.setBackgroundImage(UIImage(systemName: "ellipsis.circle"), for: .normal, barMetrics: UIBarMetrics.default)

       self.navigationController?.navigationBar.prefersLargeTitles = true
       self.navigationController?.navigationItem.largeTitleDisplayMode = .automatic
       self.navigationController?.navigationBar.backgroundColor = .systemBackground
       self.navigationController?.navigationBar.shadowImage = UIImage()
       self.navigationItem.rightBarButtonItem = barButton
       
       let searchController = UISearchController(searchResultsController: SearchRegionViewController())
       searchController.searchResultsUpdater = searchController.searchResultsController as? SearchRegionViewController
       
       self.navigationItem.searchController = searchController
    
       self.navigationItem.searchController?.searchBar.placeholder = "ÎèÑÏãú ÎòêÎäî Í≥µÌï≠ Í≤ÄÏÉâ"
       self.navigationItem.searchController?.navigationItem.titleView = searchController.searchBar
       self.navigationItem.hidesSearchBarWhenScrolling = false
       self.navigationItem.searchController?.obscuresBackgroundDuringPresentation = true
       
       self.navigationItem.title = "Í≤ÄÏÉâ"
       self.navigationController?.navigationBar.tintColor = .label
    }

    @objc func setMenu() -> UIMenu {
        let celsius = UIAction(title: "ÏÑ≠Ïî®", image: UIImage(systemName: "c.circle"), handler: {_ in
            print("ÏÑ≠Ïî®")
            defaults.set("ÏÑ≠Ïî®", forKey: "tempUnit")
            self.tableView.reloadData()
        })
        let fahrenheit = UIAction(title: "ÌôîÏî®", image: UIImage(systemName: "f.circle"), handler: {_ in
            print("ÌôîÏî®")
            defaults.set("ÌôîÏî®", forKey: "tempUnit")
            self.tableView.reloadData()
        })

        let menu = UIMenu(title: "", children: [celsius, fahrenheit])
        return menu
    }

    deinit {
        print("### SearchViewController deinitialized")
    }
    
    func configureMapData() -> LocationData{
        // Ìè¨Í∑∏ÎùºÏö¥ÎìúÏùº Îïå ÏúÑÏπò Ï∂îÏ†Å Í∂åÌïú ÏöîÏ≤≠
        self.locationManager.requestWhenInUseAuthorization()

        // Î∞∞ÌÑ∞Î¶¨Ïóê ÎßûÍ≤å Í∂åÏû•ÎêòÎäî ÏµúÏ†ÅÏùò Ï†ïÌôïÎèÑ
        self.locationManager.desiredAccuracy = kCLLocationAccuracyBest

        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌóàÏö© Î∞õÍ∏∞ alert ÎùÑÏö∞Í∏∞
        self.locationManager.requestWhenInUseAuthorization()

        // ÏïÑÏù¥Ìè∞ ÏÑ§Ï†ïÏóêÏÑúÏùò ÏúÑÏπò ÏÑúÎπÑÏä§Í∞Ä ÏºúÏßÑ ÏÉÅÌÉúÎùºÎ©¥
        DispatchQueue.main.async {
            if CLLocationManager.locationServicesEnabled() {
                print("ÏúÑÏπò ÏÑúÎπÑÏä§ On ÏÉÅÌÉú")
                self.locationManager.startUpdatingLocation() // ÏúÑÏπò Ï†ïÎ≥¥ Î∞õÏïÑÏò§Í∏∞ ÏãúÏûë
                print(self.locationManager.location?.coordinate as Any)
            } else {
                print("ÏúÑÏπò ÏÑúÎπÑÏä§ Off ÏÉÅÌÉú")
            }
        }

        // ÏúÑ,Í≤ΩÎèÑ Í∞ÄÏ†∏Ïò§Í∏∞
        var locant: LocationData = LocationData(name: "üß≠ ÌòÑÏû¨ÏúÑÏπò")
        let coor = self.locationManager.location?.coordinate
        locant.latitude = coor?.latitude
        locant.longtitude = coor?.longitude

        print("### ÌòÑÏû¨ ÏúÑÎèÑ Í≤ΩÎèÑ : \(MapManager.shared.latitude) : \(MapManager.shared.longitude)")
        print("### Ï†ÄÏû•Îêú ÌòÑÏû¨ locant Í∞í : ÏúÑÎèÑ - \(String(describing: locant.latitude)), Í≤ΩÎèÑ - \(String(describing: locant.longtitude))")
        return locant
    }
    
    func fetchData(locationArray: [LocationData]) {
        let shared = WeatherManager.shared
        var tempcurrentWeatherData: [CurrentWeatherData] = []
        Task {
            for data in locationArray {
                let latitude = data.latitude ?? 0
                let longitude = data.longtitude ?? 0
                await shared.getWeather(latitude: latitude, longitude: longitude)
                let item = WeatherManager.shared.weather?.currentWeather
                
                if let condition = item?.condition {self.tempWeatherData.condition = condition}
                if let date = item?.date {self.tempWeatherData.date = date}
                if let symbolName = item?.symbolName {self.tempWeatherData.symbolName = symbolName}
                if let temperature = item?.temperature {
                    let temperatureInt = Int(temperature.converted(to: .celsius).value)
                    self.tempWeatherData.temperature = temperatureInt
                }
                if let isDaylight = item?.isDaylight {self.tempWeatherData.isDaylight = isDaylight}
                
                print("tempWeatherData : \(tempWeatherData)")
                let temp = CurrentWeatherData(locationData: data, weatherData: self.tempWeatherData)
                tempcurrentWeatherData.append(temp)
            }
            self.currentWeatherData = tempcurrentWeatherData
            self.tableView.reloadData() //
            print("### \(String(describing: self.currentWeatherData))")
        }
    }
}
            
extension SearchViewController {
    override func numberOfSections(in tableView: UITableView) -> Int {1}

    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        currentWeatherData?.count ?? 0
    }

    override func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {120}

    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let unit = defaults.string(forKey: "tempUnit")
        let cell = tableView.dequeueReusableCell(withIdentifier: SearchTableViewCell.identifier, for: indexPath) as! SearchTableViewCell
        let data = currentWeatherData?[indexPath.row]

        // cell Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞(ÏûÑÏãúÎ°ú dummyÏôÄ Ïó∞Í≤∞)
        switch unit {
        case "ÏÑ≠Ïî®": cell.temperature.text = "\(String(describing: data!.weatherData.temperature!))‚ÑÉ"
        case "ÌôîÏî®": cell.temperature.text = "\(String(describing: Int(Double((data!.weatherData.temperature)!) * 1.8) + 32))‚Ñâ"
        default : cell.temperature.text = "\(String(describing: data!.weatherData.temperature!))‚ÑÉ"
        }
                
        cell.weather.text = switchingWeatherInfoCase(data!.weatherData.condition ?? .clear, data!.weatherData.isDaylight ?? true)[0]
        cell.city.text = data?.locationData.name
        cell.weatherImg.image = UIImage(named: switchingWeatherInfoCase(data!.weatherData.condition ?? .clear, data!.weatherData.isDaylight ?? true)[1])
        cell.weatherImg.tintColor = .label
        
        switch data!.weatherData.isDaylight {
        case true: cell.backgroundImg.image = UIImage(named: "back_day_searchPage")
        case false: cell.backgroundImg.image = UIImage(named: "back_night_searchPage")
        default: cell.backgroundImg.image = UIImage(named: "back_day_searchPage")
        }
        
        cell.selectionStyle = .none
        
        return cell
    }
    
    override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let selectedLat = currentWeatherData![indexPath.row].locationData.latitude
        let selectedLong = currentWeatherData![indexPath.row].locationData.longtitude
        
        MapManager.shared.latitude = selectedLat!
        MapManager.shared.longitude = selectedLong!
        let currentVC = CurrentViewController()
        
        self.navigationController?.popViewController(animated: true)
    }
    
}

func switchingWeatherInfoCase(_ condition: WeatherCondition, _ isDaylight: Bool) -> [String] {
    
    var conditionString: String
    var imgString: String
    switch condition {
    case .clear:
        conditionString = "ÎßëÏùå"
        if isDaylight {imgString = "clear_sky_day"}
        else {imgString = "clear_sky_night"}
    case .cloudy:
        conditionString = "ÌùêÎ¶º"
        imgString = "clouds"
    case .mostlyClear:
        conditionString = "ÎåÄÎ∂ÄÎ∂Ñ ÎßëÏùå"
        if isDaylight {imgString = "clear_sky_day"}
        else {imgString = "clear_sky_night"}
    case .blowingDust:
        conditionString = "ÌíçÏßÑ"
        imgString = "atmosphere"
    case .foggy:
        conditionString = "ÏïàÍ∞ú"
        imgString = "atmosphere"
    case .haze:
        conditionString = "ÏïàÍ∞ú"
        imgString = "atmosphere"
    case .mostlyCloudy:
        conditionString = "ÎåÄÏ≤¥Î°ú ÌùêÎ¶º"
        imgString = "clouds"
    case .partlyCloudy:
        conditionString = "Î∂ÄÎ∂ÑÏ†ÅÏúºÎ°ú ÌùêÎ¶º"
        imgString = "clouds"
    case .smoky:
        conditionString = "Ïπ®Ïπ®Ìïú"
        imgString = "clouds"
    case .breezy:
        conditionString = "Í∞ÄÎ≤ºÏö¥ Î∞îÎûå"
        imgString = "wind"
    case .windy:
        conditionString = "Í∞ïÌíç"
        imgString = "wind"
    case .drizzle:
        conditionString = "Ïù¥Ïä¨ÎπÑ"
        imgString = "rain"
    case .heavyRain:
        conditionString = "Ìè≠Ïö∞"
        imgString = "rain"
    case .isolatedThunderstorms:
        conditionString = "ÎáåÏö∞"
        imgString = "rain"
    case .rain:
        conditionString = "ÎπÑ"
        imgString = "rain"
    case .sunShowers:
        conditionString = "Ïó¨Ïö∞ÎπÑ"
        imgString = "rain"
    case .scatteredThunderstorms:
        conditionString = "ÎáåÏö∞"
        imgString = "thunderstorm_with_rain"
    case .strongStorms:
        conditionString = "Í∞ïÌïú ÎáåÏö∞"
        imgString = "thunderstorm_with_rain"
    case .thunderstorms:
        conditionString = "ÎáåÏö∞"
        imgString = "thunderstorm_with_rain"
    case .frigid:
        conditionString = "ÏÑúÎ¶¨"
        imgString = "snow"
    case .hail:
        conditionString = "ÎπóÎ∞ú"
        imgString = "rain"
    case .hot:
        conditionString = "Ìè≠Ïóº"
        if isDaylight {imgString = "clear_sky_day"}
        else {imgString = "clear_sky_night"}
    case .flurries:
        conditionString = "Ìè≠ÌíçÏö∞"
        imgString = "rain"
    case .sleet:
        conditionString = "ÏßÑÎààÍπ®ÎπÑ"
        imgString = "snow"
    case .snow:
        conditionString = "Îàà"
        imgString = "snow"
    case .sunFlurries:
        conditionString = "ÎààÎ≥¥Îùº"
        imgString = "snow"
    case .wintryMix:
        conditionString = "ÏßÑÎààÍπ®ÎπÑ"
        imgString = "snow"
    case .blizzard:
        conditionString = "ÎààÎ≥¥Îùº"
        imgString = "snow"
    case .blowingSnow:
        conditionString = "ÎààÎ≥¥Îùº"
        imgString = "snow"
    case .freezingDrizzle:
        conditionString = "ÏßÑÎààÍπ®ÎπÑ"
        imgString = "snow"
    case .freezingRain:
        conditionString = "Ïñ¥Îäî ÎπÑ"
        imgString = "snow"
    case .heavySnow:
        conditionString = "Ìè≠ÏÑ§"
        imgString = "snow"
    case .hurricane:
        conditionString = "ÌóàÎ¶¨ÏºÄÏù∏"
        imgString = "tornado"
    case .tropicalStorm:
        conditionString = "Ïó¥ÎåÄÏÑ± Ìè≠Ìíç"
        imgString = "tornado"
    default : conditionString = "ÎßëÏùå"
        if isDaylight {imgString = "clear_sky_day"}
        else {imgString = "clear_sky_night"}
    }
    return [conditionString, imgString]
}
